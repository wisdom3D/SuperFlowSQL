version: "3.9"

services:
  # ==========================
  # ğŸ˜ POSTGRESQL
  # ==========================
  postgres:
    image: postgres:15
    container_name: postgres
    environment:
      POSTGRES_USER: airflow
      POSTGRES_PASSWORD: airflow
      POSTGRES_DB: airflow
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - data_platform

  # ==========================
  # ğŸ§  PGADMIN
  # ==========================
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@admin.com
      PGADMIN_DEFAULT_PASSWORD: admin
    ports:
      - "5050:80"
    depends_on:
      - postgres
    networks:
      - data_platform

  # ==========================
  # ğŸª¶ AIRFLOW - WEBSERVER
  # ==========================
  airflow-webserver:
    build:
      context: .
      dockerfile: Dockerfile.airflow
    image: custom-airflow:latest
    container_name: airflow-webserver
    environment:
      AIRFLOW__CORE__EXECUTOR: LocalExecutor
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://airflow:airflow@postgres:5432/airflow
      AIRFLOW__CORE__FERNET_KEY: "2I7ZQJKF7T1Q4fjYlq6hZkM1U1_6fE0tVgE7vP1zJkA="
      AIRFLOW__WEBSERVER__DEFAULT_UI_TIMEZONE: UTC
      AIRFLOW__CORE__LOAD_EXAMPLES: "False"
    volumes:
      - ./dags:/opt/airflow/dags
      - airflow_logs:/opt/airflow/logs
      - airflow_plugins:/opt/airflow/plugins
    ports:
      - "8080:8080"
    depends_on:
      - postgres
    networks:
      - data_platform
    entrypoint: /bin/bash
    command: -c "
      airflow db init &&
      airflow users create --username admin --password admin --firstname Airflow --lastname Admin --role Admin --email admin@example.com &&
      airflow connections delete 'postgres_default' || true &&
      airflow connections add 'postgres_default' \
        --conn-type 'postgres' \
        --conn-login 'airflow' \
        --conn-password 'airflow' \
        --conn-host 'postgres' \
        --conn-port '5432' \
        --conn-schema 'airflow' &&
      exec airflow webserver
      "

  # ==========================
  # ğŸª¶ AIRFLOW - SCHEDULER
  # ==========================
  airflow-scheduler:
    build:
      context: .
      dockerfile: Dockerfile.airflow
    image: custom-airflow:latest
    container_name: airflow-scheduler
    environment:
      AIRFLOW__CORE__EXECUTOR: LocalExecutor
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://airflow:airflow@postgres:5432/airflow
      AIRFLOW__CORE__FERNET_KEY: "2I7ZQJKF7T1Q4fjYlq6hZkM1U1_6fE0tVgE7vP1zJkA="
      AIRFLOW__WEBSERVER__DEFAULT_UI_TIMEZONE: UTC
      AIRFLOW__CORE__LOAD_EXAMPLES: "False"
    volumes:
      - ./dags:/opt/airflow/dags
      - airflow_logs:/opt/airflow/logs
      - airflow_plugins:/opt/airflow/plugins
    depends_on:
      - postgres
      - airflow-webserver
    networks:
      - data_platform
    entrypoint: /bin/bash
    command: -c "airflow scheduler"

  # ==========================
  # ğŸ“Š SUPERSET
  # ==========================
  superset:
    image: apache/superset:3.0.2
    container_name: superset
    restart: always
    depends_on:
      - postgres
    environment:
      SUPERSET_SECRET_KEY: "supersetsecret123"
      # Connexion Ã  PostgreSQL au lieu de SQLite
      SUPERSET_DATABASE_URI: postgresql+psycopg2://airflow:airflow@postgres:5432/superset
    ports:
      - "8088:8088"
    volumes:
      - superset_home:/app/superset_home
      - superset_logs:/app/superset_logs
    networks:
      - data_platform
    command: >
      /bin/bash -c "superset db upgrade &&
                    superset fab create-admin --username admin --password admin --firstname Admin --lastname User --email admin@example.com &&
                    superset init &&
                    superset run -h 0.0.0.0 -p 8088"

# ==========================
# ğŸ”— NETWORKS & VOLUMES
# ==========================
networks:
  data_platform:

volumes:
  postgres_data:
  airflow_logs:
  airflow_plugins:
  superset_home:
  superset_logs:
